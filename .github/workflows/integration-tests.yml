name: Integration Tests

on:
    push:
        branches: ["main", "develop", "test/**"]
    pull_request:
        branches: ["main", "develop"]
    workflow_dispatch: # Allows manual triggering

permissions:
    contents: read

jobs:
    integration-tests:
        name: Run Integration Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Cache Maven packages
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            - name: Run integration tests
              run: mvn clean test -Dtest="*IntegrationTest" -Dspring.profiles.active=test

            - name: Generate JaCoCo coverage report
              if: success() || failure()
              run: mvn jacoco:report

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always() # Always upload, even on failure
              with:
                  name: integration-test-results
                  path: |
                      target/surefire-reports/
                      target/site/jacoco/

            - name: Display test results summary
              if: always()
              run: |
                  echo "ğŸ“Š Integration Test Results Summary"
                  echo "=================================="
                  
                  # Count test results
                  if [ -d "target/surefire-reports" ]; then
                      TOTAL_TESTS=$(find target/surefire-reports -name "TEST-*.xml" -exec grep -l "testcase" {} \; | wc -l)
                      FAILED_TESTS=$(find target/surefire-reports -name "*.xml" -exec grep -c "failure\|error" {} \; | awk '{sum+=$1} END {print sum}')
                      SUCCESS_TESTS=$((TOTAL_TESTS - FAILED_TESTS))
                      
                      echo "âœ… Successful tests: $SUCCESS_TESTS"
                      echo "âŒ Failed tests: $FAILED_TESTS"
                      echo "ğŸ“ˆ Total tests: $TOTAL_TESTS"
                      
                      if [ $FAILED_TESTS -gt 0 ]; then
                          echo "âš ï¸  Some tests failed - check the logs above"
                          exit 1
                      else
                          echo "ğŸ‰ All integration tests passed!"
                      fi
                  else
                      echo "âŒ No test results found"
                      exit 1
                  fi

            - name: Display coverage summary
              if: always()
              run: |
                  echo ""
                  echo "ğŸ“Š Coverage Report Summary"
                  echo "=========================="
                  
                  if [ -f "target/site/jacoco/jacoco.xml" ]; then
                      # Extract coverage percentages from JaCoCo XML
                      INSTRUCTION_COVERAGE=$(grep -o 'type="INSTRUCTION".*covered="[0-9]*".*missed="[0-9]*"' target/site/jacoco/jacoco.xml | head -1 | sed -E 's/.*covered="([0-9]*)".*missed="([0-9]*).*/\1 \2/' | awk '{covered=$1; missed=$2; total=covered+missed; if(total>0) print int((covered/total)*100); else print 0}')
                      BRANCH_COVERAGE=$(grep -o 'type="BRANCH".*covered="[0-9]*".*missed="[0-9]*"' target/site/jacoco/jacoco.xml | head -1 | sed -E 's/.*covered="([0-9]*)".*missed="([0-9]*).*/\1 \2/' | awk '{covered=$1; missed=$2; total=covered+missed; if(total>0) print int((covered/total)*100); else print 0}')
                      
                      echo "ğŸ“ˆ Instruction Coverage: ${INSTRUCTION_COVERAGE}%"
                      echo "ğŸŒ¿ Branch Coverage: ${BRANCH_COVERAGE}%"
                      
                      # Check thresholds
                      MIN_COVERAGE=80
                      if [ "$INSTRUCTION_COVERAGE" -ge "$MIN_COVERAGE" ]; then
                          echo "âœ… Coverage meets minimum threshold (${MIN_COVERAGE}%)"
                      else
                          echo "âš ï¸  Coverage below minimum threshold (${MIN_COVERAGE}%)"
                          echo "ğŸ’¡ Consider adding more tests to improve coverage"
                      fi
                      
                      echo "ğŸ“„ Detailed coverage report available in artifacts"
                  else
                      echo "âŒ Coverage report not generated"
                  fi

            - name: Integration test completion
              if: always()
              run: |
                  echo ""
                  echo "ğŸ Integration Test Workflow Complete"
                  echo "===================================="
                  echo "âœ… Tests executed with Spring 'test' profile"
                  echo "ğŸ“¦ Test results uploaded as artifacts"
                  echo "ğŸ“Š Coverage reports generated"
                  echo "ï¿½ Check the 'Actions' tab for detailed logs and artifacts"
