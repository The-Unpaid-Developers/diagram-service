name: Integration Tests

on:
    push:
        branches: ["main", "develop", "test/**"]
    pull_request:
        branches: ["main", "develop"]
    workflow_dispatch: # Allows manual triggering

permissions:
    contents: read
    issues: read
    checks: write
    pull-requests: write

jobs:
    integration-tests:
        name: Run Integration Tests
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v4

            - name: Set up JDK 21
              uses: actions/setup-java@v4
              with:
                  java-version: "21"
                  distribution: "temurin"

            - name: Cache Maven packages
              uses: actions/cache@v4
              with:
                  path: ~/.m2
                  key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
                  restore-keys: ${{ runner.os }}-m2

            - name: Run integration tests
              run: mvn clean test -Dtest="*IntegrationTest" -Dspring.profiles.active=test

            - name: Generate JaCoCo coverage report
              if: success() || failure()
              run: mvn jacoco:report

            - name: Upload test results
              uses: actions/upload-artifact@v4
              if: always() # Always upload, even on failure
              with:
                  name: integration-test-results
                  path: |
                      target/surefire-reports/
                      target/site/jacoco/

            - name: Publish test report
              uses: dorny/test-reporter@v1
              if: success() || failure()
              with:
                  name: Integration Tests Report
                  path: target/surefire-reports/*.xml
                  reporter: java-junit
                  fail-on-error: true

            - name: Comment test results on PR
              uses: EnricoMi/publish-unit-test-result-action@v2
              if: always() && github.event_name == 'pull_request'
              with:
                  files: target/surefire-reports/*.xml
                  check_name: "Integration Test Results"
                  comment_title: "ğŸ§ª Integration Test Results"

            - name: Add coverage comment to PR
              uses: madrapps/jacoco-report@v1.6.1
              if: github.event_name == 'pull_request'
              with:
                  paths: target/site/jacoco/jacoco.xml
                  token: ${{ secrets.GITHUB_TOKEN }}
                  min-coverage-overall: 80
                  min-coverage-changed-files: 80
                  title: "ğŸ“Š Code Coverage Report"
              continue-on-error: true

            - name: Check coverage thresholds
              if: success() || failure()
              run: |
                  echo "âœ… Integration tests completed!"
                  echo "ğŸ“Š Coverage reports generated"
                  echo "ğŸ“ˆ Target: 80%+ overall coverage"

            - name: Display coverage summary
              if: always()
              run: |
                  echo ""
                  echo "ğŸ“Š Coverage Report Summary"
                  echo "=========================="
                  
                  if [ -f "target/site/jacoco/jacoco.xml" ]; then
                      # Extract coverage percentages from JaCoCo XML
                      INSTRUCTION_COVERAGE=$(grep -o 'type="INSTRUCTION".*covered="[0-9]*".*missed="[0-9]*"' target/site/jacoco/jacoco.xml | head -1 | sed -E 's/.*covered="([0-9]*)".*missed="([0-9]*).*/\1 \2/' | awk '{covered=$1; missed=$2; total=covered+missed; if(total>0) print int((covered/total)*100); else print 0}')
                      BRANCH_COVERAGE=$(grep -o 'type="BRANCH".*covered="[0-9]*".*missed="[0-9]*"' target/site/jacoco/jacoco.xml | head -1 | sed -E 's/.*covered="([0-9]*)".*missed="([0-9]*).*/\1 \2/' | awk '{covered=$1; missed=$2; total=covered+missed; if(total>0) print int((covered/total)*100); else print 0}')
                      
                      echo "ğŸ“ˆ Instruction Coverage: ${INSTRUCTION_COVERAGE}%"
                      echo "ğŸŒ¿ Branch Coverage: ${BRANCH_COVERAGE}%"
                      
                      # Check thresholds
                      MIN_COVERAGE=80
                      if [ "$INSTRUCTION_COVERAGE" -ge "$MIN_COVERAGE" ]; then
                          echo "âœ… Coverage meets minimum threshold (${MIN_COVERAGE}%)"
                      else
                          echo "âš ï¸  Coverage below minimum threshold (${MIN_COVERAGE}%)"
                          echo "ğŸ’¡ Consider adding more tests to improve coverage"
                      fi
                      
                      echo "ğŸ“„ Detailed coverage report available in artifacts"
                  else
                      echo "âŒ Coverage report not generated"
                  fi

            - name: Integration test completion
              if: always()
              run: |
                  echo ""
                  echo "ğŸ Integration Test Workflow Complete"
                  echo "===================================="
                  echo "âœ… Tests executed with Spring 'test' profile"
                  echo "ğŸ“¦ Test results uploaded as artifacts"
                  echo "ğŸ“Š Coverage reports generated"
                  echo "ï¿½ Check the 'Actions' tab for detailed logs and artifacts"
